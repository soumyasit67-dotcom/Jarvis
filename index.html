<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
            overflow: hidden;
            position: relative;
        }
        #backgroundCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.5;
        }
        .glow-text {
            text-shadow: 0 0 8px #0ff, 0 0 16px #0ff, 0 0 24px #0ff;
        }
        #hologramCanvas {
            width: 100%;
            height: 400px;
            max-width: 600px;
            display: block;
        }
        .container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            z-index: 1;
            transition: all 1s cubic-bezier(0.77, 0, 0.175, 1);
        }
        .split-transition {
            transform: scaleX(0);
            opacity: 0;
        }
        .fade-out {
            opacity: 0;
        }
        #message-box {
            font-size: 0.875rem;
            line-height: 1.5;
            letter-spacing: 0.05em;
            width: 100%;
            height: 200px;
            background-color: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            border-radius: 1rem;
            border: 1px solid #374151;
            padding: 1rem;
            margin-top: 1rem;
            box-shadow: inset 0 0 10px rgba(0, 255, 255, 0.2);
            overflow-y: auto;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            cursor: pointer;
        }
        .user-message, .jarvis-message {
            max-width: 80%;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
        }
        .user-message {
            background-color: rgba(255, 255, 255, 0.1);
            align-self: flex-end;
            border-bottom-right-radius: 0;
        }
        .jarvis-message {
            background-color: rgba(0, 255, 255, 0.1);
            align-self: flex-start;
            border-bottom-left-radius: 0;
        }
        /* New UI Styles */
        .full-ui {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 600px;
            padding: 2rem;
            background: linear-gradient(145deg, #1e1e2d, #14141e);
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), inset 0 0 15px rgba(0, 255, 255, 0.2);
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        .full-ui.visible {
            display: flex;
            opacity: 1;
        }
        .back-btn {
            background: #4a4a6e;
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .back-btn:hover {
            background: #5c5c8f;
        }
        /* Specific UI Styles */
        #display {
            width: 100%;
            height: 4rem;
            background-color: #1a1a2e;
            color: #00ffff;
            font-size: 2rem;
            text-align: right;
            border-radius: 0.75rem;
            padding: 0 1rem;
            margin-bottom: 1rem;
            box-shadow: inset 0 0 10px #0ff;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            overflow-x: auto;
        }
        #buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            width: 100%;
        }
        .btn {
            background-color: #2a2a3e;
            color: #e0e0e0;
            border: none;
            border-radius: 1rem;
            padding: 1.5rem;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5), -5px -5px 10px rgba(45, 45, 70, 0.2);
        }
        .btn:hover {
            background-color: #3f3f5a;
            transform: translateY(-2px);
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.7), -5px -5px 15px rgba(45, 45, 70, 0.3);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.5), inset -2px -2px 5px rgba(45, 45, 70, 0.2);
        }
        .operator {
            color: #00ffff;
        }
        .equal {
            background-color: #008080;
            color: white;
        }
        .clear {
            background-color: #8b0000;
            color: white;
        }
        .calculator-message-box {
            height: 100px;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            border-radius: 1rem;
            border: 1px solid #374151;
            padding: 1rem;
            margin-top: 1rem;
            box-shadow: inset 0 0 10px rgba(0, 255, 255, 0.2);
            overflow-y: auto;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        #time-display {
            font-family: 'Orbitron', sans-serif;
            font-size: 5rem;
            font-weight: 700;
            color: #00ffff;
            text-shadow: 0 0 10px #0ff, 0 0 20px #0ff;
            line-height: 1;
        }
        #current-date {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: #00ffff;
            text-shadow: 0 0 10px #0ff, 0 0 20px #0ff;
            text-align: center;
            line-height: 1.2;
        }
        #alarm-ui h2, #alarm-ui p {
            text-align: center;
        }
        #alarm-time-input {
            width: 100%;
            max-width: 250px;
            padding: 0.5rem;
            font-size: 1.5rem;
            background-color: #1a1a2e;
            color: #00ffff;
            border: 2px solid #00ffff;
            border-radius: 0.5rem;
            margin-top: 1rem;
            text-align: center;
        }
        #set-alarm-btn, #cancel-alarm-btn {
            margin-top: 1rem;
            padding: 1rem 2rem;
            font-size: 1.25rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #set-alarm-btn {
            background-color: #008080;
            color: white;
            border: none;
        }
        #set-alarm-btn:hover {
            background-color: #005f5f;
        }
        #cancel-alarm-btn {
            background-color: #8b0000;
            color: white;
            border: none;
        }
        #cancel-alarm-btn:hover {
            background-color: #6a0000;
        }
        #alarm-status {
            margin-top: 1rem;
            font-size: 1.125rem;
            color: #00ffff;
            text-shadow: 0 0 5px #0ff;
        }
        
        /* New Alarm Ringing UI */
        #alarm-ringing-ui {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #8b0000; /* Dark red */
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            text-align: center;
            color: white;
            transition: opacity 1s ease-in-out;
            opacity: 0;
        }
        #alarm-ringing-ui.visible {
            display: flex;
            opacity: 1;
        }
        #ringing-message {
            font-size: 2.5rem;
            font-weight: bold;
            text-transform: uppercase;
            text-shadow: 0 0 10px white, 0 0 20px white;
            animation: pulse-glow 2s infinite ease-in-out;
        }
        #ringing-time {
            font-family: 'Orbitron', sans-serif;
            font-size: 6rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 0 10px white, 0 0 20px white;
            margin-top: 1rem;
        }
        #stop-alarm-btn {
            margin-top: 2rem;
            padding: 1.5rem 4rem;
            font-size: 1.5rem;
            border: 3px solid white;
            background-color: transparent;
            color: white;
            cursor: pointer;
            border-radius: 100px;
            transition: all 0.3s ease;
        }
        #stop-alarm-btn:hover {
            background-color: white;
            color: #8b0000;
        }
        
        @keyframes pulse-glow {
            0% { text-shadow: 0 0 10px white, 0 0 20px white; }
            50% { text-shadow: 0 0 15px white, 0 0 30px white; }
            100% { text-shadow: 0 0 10px white, 0 0 20px white; }
        }

        /* Virtual Keypad UI Styles */
        #keypad-ui {
            padding: 2rem;
        }
        #keypad-input {
            width: 100%;
            padding: 1rem;
            font-size: 1.25rem;
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid #00ffff;
            color: #e0e0e0;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            box-shadow: inset 0 0 8px #0ff;
        }
        #keypad-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.75rem;
            width: 100%;
            max-width: 500px;
        }
        .key-btn {
            background-color: #2a2a3e;
            color: #e0e0e0;
            border: none;
            border-radius: 0.75rem;
            padding: 1rem 0.5rem;
            font-size: 1.125rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.5), -3px -3px 8px rgba(45, 45, 70, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .key-btn:hover {
            background-color: #3f3f5a;
            transform: translateY(-2px);
            box-shadow: 3px 3px 12px rgba(0, 0, 0, 0.7), -3px -3px 12px rgba(45, 45, 70, 0.3);
        }
        .key-btn:active {
            transform: translateY(0);
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.5), inset -1px -1px 3px rgba(45, 45, 70, 0.2);
        }
        .key-btn.space {
            grid-column: span 2;
        }
        .key-btn.send {
            grid-column: span 3;
            background-color: #008080;
        }
        .key-btn.del {
            background-color: #8b0000;
        }
        .key-btn.shift, .key-btn.caps {
            background-color: #4a4a6e;
        }

        /* New Log UI Styles */
        #log-ui {
            display: none;
            flex-direction: column;
            width: 100%;
            max-width: 800px;
            padding: 2rem;
            background: linear-gradient(145deg, #1e1e2d, #14141e);
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), inset 0 0 15px rgba(0, 255, 255, 0.2);
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        #log-ui.visible {
            display: flex;
            opacity: 1;
        }
        #log-display {
            width: 100%;
            height: 60vh;
            background-color: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            border-radius: 1rem;
            border: 1px solid #374151;
            padding: 1.5rem;
            overflow-y: auto;
            color: #e0e0e0;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.875rem;
            line-height: 1.6;
            white-space: pre-wrap; /* Preserve formatting */
            box-shadow: inset 0 0 10px rgba(0, 255, 255, 0.2);
        }
        .log-entry {
            margin-bottom: 1rem;
            border-bottom: 1px dashed rgba(0, 255, 255, 0.2);
            padding-bottom: 1rem;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-timestamp {
            color: #00ffff;
            font-size: 0.75rem;
            display: block;
            margin-bottom: 0.5rem;
        }
        .log-message {
            color: #e0e0e0;
        }
        .log-user {
            color: #ffcc00; /* Yellow for user messages */
        }
        .log-jarvis {
            color: #00ffff; /* Cyan for Jarvis messages */
        }

        /* New Command Pad UI */
        #command-pad-ui {
            display: none;
            flex-direction: column;
            width: 100%;
            max-width: 800px;
            padding: 2rem;
            background: linear-gradient(145deg, #1e1e2d, #14141e);
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), inset 0 0 15px rgba(0, 255, 255, 0.2);
            opacity: 0;
            transition: opacity 1s ease-in-out;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.1);
            transform-origin: center;
        }

        #command-pad-ui.visible {
            display: flex;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            transition: transform 1s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 1s ease-in-out;
        }
        #command-pad-content {
            width: 100%;
            height: 60vh;
            background-color: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            border-radius: 1rem;
            border: 1px solid #374151;
            padding: 1.5rem;
            overflow-y: auto;
            color: #e0e0e0;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.875rem;
            line-height: 1.6;
            white-space: pre-wrap;
            box-shadow: inset 0 0 10px rgba(0, 255, 255, 0.2);
        }
        .command-entry {
            margin-bottom: 1.5rem;
        }
        .command-name {
            font-weight: bold;
            color: #00ffff;
            text-transform: uppercase;
        }
        .command-description {
            color: #e0e0e0;
        }

        .cinematic-light {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #00ffff 0%, transparent 70%);
            opacity: 0;
            pointer-events: none;
            z-index: 50;
            transform: scale(0);
            transition: transform 1s ease-out, opacity 1s ease-out;
        }
    </style>
</head>
<body>
    <canvas id="backgroundCanvas"></canvas>
    
    <audio id="alarm-sound" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" loop></audio>

    <div id="main-ui" class="container text-center w-full max-w-2xl">
        <h1 id="title" class="text-4xl sm:text-5xl font-bold mb-4 glow-text">J.A.R.V.I.S.</h1>
        <p id="subtitle" class="text-lg sm:text-xl text-gray-400 mb-8">Personal AI Assistant</p>

        <canvas id="hologramCanvas"></canvas>

        <div id="status-display" class="bg-slate-700 text-gray-300 py-3 px-6 rounded-xl mt-6 w-full text-sm sm:text-base">
            
        </div>
        
        <div id="message-box">
            <p class="text-gray-500 italic text-center">Messages will appear here.</p>
        </div>
    </div>

    <div id="calculator" class="full-ui">
        <button id="calc-back-btn" class="back-btn self-start">Back</button>
        <div id="display">0</div>
        <div id="buttons">
            <button class="btn clear">C</button>
            <button class="btn operator">/</button>
            <button class="btn operator">*</button>
            <button class="btn operator">-</button>
            <button class="btn">7</button>
            <button class="btn">8</button>
            <button class="btn">9</button>
            <button class="btn operator">+</button>
            <button class="btn">4</button>
            <button class="btn">5</button>
            <button class="btn">6</button>
            <button class="btn">.</button>
            <button class="btn">1</button>
            <button class="btn">2</button>
            <button class="btn">3</button>
            <button class="btn equal col-span-2">=</button>
            <button class="btn">0</button>
        </div>
        <div id="calculator-message-box" class="calculator-message-box">
            <p class="text-gray-500 italic text-center">Calculations will appear here.</p>
        </div>
    </div>

    <div id="notepad" class="full-ui">
        <button id="notepad-back-btn" class="back-btn self-start">Back</button>
        <h2 class="text-3xl font-bold mb-4 glow-text">Notepad</h2>
        <textarea id="notepad-text" class="w-full h-80 bg-slate-800 text-gray-200 border border-slate-600 rounded-lg p-4 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition-colors" placeholder="Start typing..."></textarea>
    </div>

    <div id="clock" class="full-ui">
        <button id="clock-back-btn" class="back-btn self-start">Back</button>
        <h2 class="text-xl font-bold mt-4 mb-2 glow-text">Current Time</h2>
        <div id="time-display" class="mb-4"></div>
    </div>

    <div id="date-display" class="full-ui">
        <button id="date-back-btn" class="back-btn self-start">Back</button>
        <h2 class="text-xl font-bold mt-4 mb-2 glow-text">Current Date</h2>
        <div id="current-date"></div>
    </div>
    
    <div id="alarm-ui" class="full-ui">
        <button id="alarm-back-btn" class="back-btn self-start">Back</button>
        <h2 class="text-3xl font-bold mb-4 glow-text">Set Alarm</h2>
        <p class="text-center text-gray-400 mb-4">Please input a time or say 'set alarm for [time]'</p>
        <input type="time" id="alarm-time-input" class="rounded-xl border-none">
        <div class="flex gap-4">
            <button id="set-alarm-btn">Set Alarm</button>
            <button id="cancel-alarm-btn" class="hidden">Cancel Alarm</button>
        </div>
        <p id="alarm-status"></p>
    </div>
    
    <div id="alarm-ringing-ui">
        <h1 id="ringing-message">ALARM! WAKE UP, SIR.</h1>
        <p id="ringing-time"></p>
        <button id="stop-alarm-btn">STOP</button>
    </div>

    <div id="keypad-ui" class="full-ui">
        <button id="keypad-back-btn" class="back-btn self-start">Back</button>
        <h2 class="text-3xl font-bold mb-4 glow-text">Type Command</h2>
        <input type="text" id="keypad-input" placeholder="Type your command...">
        <div id="keypad-buttons">
            </div>
    </div>
    
    <div id="log-ui" class="full-ui">
        <div class="flex justify-between w-full items-center">
            <button id="log-back-btn" class="back-btn">Back</button>
            <h2 class="text-3xl font-bold glow-text">System Log</h2>
            <button id="delete-logs-btn" class="back-btn">Delete Logs</button>
        </div>
        <div id="log-display">
            <p class="text-gray-500 italic text-center mt-4">System activity will appear here.</p>
        </div>
    </div>

    <div id="command-pad-ui" class="full-ui">
        <button id="command-pad-back-btn" class="back-btn self-start">Back</button>
        <h2 class="text-3xl font-bold mb-4 glow-text">Command List</h2>
        <div id="command-pad-content">
            </div>
    </div>
    
    <div id="cinematic-light" class="cinematic-light"></div>


    <script type="module">
        // Web Speech API check
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const SpeechSynthesis = window.speechSynthesis;

        // HTML elements
        const mainUi = document.getElementById('main-ui');
        const statusDisplay = document.getElementById('status-display');
        const hologramCanvas = document.getElementById('hologramCanvas');
        const backgroundCanvas = document.getElementById('backgroundCanvas');
        const messageBox = document.getElementById('message-box');
        const calculator = document.getElementById('calculator');
        const display = document.getElementById('display');
        const buttons = document.getElementById('buttons');
        const calculatorMessageBox = document.getElementById('calculator-message-box');
        const notepad = document.getElementById('notepad');
        const notepadText = document.getElementById('notepad-text');
        const calcBackBtn = document.getElementById('calc-back-btn');
        const notepadBackBtn = document.getElementById('notepad-back-btn');
        const clock = document.getElementById('clock');
        const timeDisplay = document.getElementById('time-display');
        const clockBackBtn = document.getElementById('clock-back-btn');
        const dateDisplay = document.getElementById('date-display');
        const currentDate = document.getElementById('current-date');
        const dateBackBtn = document.getElementById('date-back-btn');
        const alarmUi = document.getElementById('alarm-ui');
        const alarmTimeInput = document.getElementById('alarm-time-input');
        const setAlarmBtn = document.getElementById('set-alarm-btn');
        const cancelAlarmBtn = document.getElementById('cancel-alarm-btn');
        const alarmSound = document.getElementById('alarm-sound');
        const alarmBackBtn = document.getElementById('alarm-back-btn');
        const alarmStatus = document.getElementById('alarm-status');
        const alarmRingingUi = document.getElementById('alarm-ringing-ui');
        const ringingMessage = document.getElementById('ringing-message');
        const ringingTime = document.getElementById('ringing-time');
        const stopAlarmBtn = document.getElementById('stop-alarm-btn');
        
        // New Keypad elements
        const keypadUi = document.getElementById('keypad-ui');
        const keypadInput = document.getElementById('keypad-input');
        const keypadButtons = document.getElementById('keypad-buttons');
        const keypadBackBtn = document.getElementById('keypad-back-btn');

        // New Log elements
        const logUi = document.getElementById('log-ui');
        const logDisplay = document.getElementById('log-display');
        const logBackBtn = document.getElementById('log-back-btn');
        const deleteLogsBtn = document.getElementById('delete-logs-btn');

        // New Command Pad elements
        const commandPadUi = document.getElementById('command-pad-ui');
        const commandPadBackBtn = document.getElementById('command-pad-back-btn');
        const commandPadContent = document.getElementById('command-pad-content');
        const cinematicLight = document.getElementById('cinematic-light');

        // Speech recognition and synthesis variables
        let recognition = null;
        let isSpeaking = false;
        let shouldRestart = true;
        let selectedVoice = null;
        let hasSpokenStartupMessage = false;
        let activeUi = 'main-ui';
        let clockInterval = null;
        let alarmTimeout = null;
        let systemLog = [];
        
        // Screen Recording Variables
        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;

        // --- Three.js for Hologram Head ---
        let headScene, headCamera, headRenderer, head, mouth, eyeLeft, eyeRight;
        let eyebrowLeft, eyebrowRight, nose, earLeft, earRight;
        let eyeOpenProgress = 0;
        let eyeOpenDirection = 0;

        const setupHologram = () => {
            headScene = new THREE.Scene();
            headScene.background = null;
            headCamera = new THREE.PerspectiveCamera(75, hologramCanvas.offsetWidth / hologramCanvas.offsetHeight, 0.1, 1000);
            headCamera.position.z = 2.5;
            headRenderer = new THREE.WebGLRenderer({ canvas: hologramCanvas, antialias: true, alpha: true });
            headRenderer.setPixelRatio(window.devicePixelRatio);
            headRenderer.setSize(hologramCanvas.offsetWidth, hologramCanvas.offsetHeight);

            const wireframeMaterial = new THREE.MeshBasicMaterial({ color: 0x00ffff, wireframe: true, transparent: true, opacity: 0.3, depthTest: true, depthWrite: true });
            const headGeometry = new THREE.DodecahedronGeometry(1.0, 1);
            head = new THREE.Mesh(headGeometry, wireframeMaterial);
            headScene.add(head);

            const eyeGeometry = new THREE.SphereGeometry(0.1, 8, 8);
            const eyeMaterial = new THREE.MeshBasicMaterial({ color: 0x00ffff, wireframe: true });
            eyeLeft = new THREE.Mesh(eyeGeometry, eyeMaterial);
            eyeRight = new THREE.Mesh(eyeGeometry, eyeMaterial);
            eyeLeft.position.set(-0.3, 0.2, 0.95);
            eyeRight.position.set(0.3, 0.2, 0.95);
            headScene.add(eyeLeft);
            headScene.add(eyeRight);

            const eyebrowGeometry = new THREE.TorusGeometry(0.15, 0.02, 8, 8);
            eyebrowLeft = new THREE.Mesh(eyebrowGeometry, wireframeMaterial);
            eyebrowRight = new THREE.Mesh(eyebrowGeometry, wireframeMaterial);
            eyebrowLeft.position.set(-0.35, 0.45, 0.95);
            eyebrowRight.position.set(0.35, 0.45, 0.95);
            eyebrowLeft.rotation.z = -Math.PI / 10;
            eyebrowRight.rotation.z = Math.PI / 10;
            headScene.add(eyebrowLeft);
            headScene.add(eyebrowRight);

            const noseGeometry = new THREE.TorusKnotGeometry(0.1, 0.03, 32, 8, 1, 1);
            nose = new THREE.Mesh(noseGeometry, wireframeMaterial);
            nose.position.set(0, -0.1, 1.0);
            nose.rotation.x = Math.PI / 2;
            headScene.add(nose);

            const earGeometry = new THREE.TorusGeometry(0.2, 0.05, 8, 8);
            earLeft = new THREE.Mesh(earGeometry, wireframeMaterial);
            earRight = new THREE.Mesh(earGeometry, wireframeMaterial);
            earLeft.position.set(-1.05, 0.1, 0);
            earRight.position.set(1.05, 0.1, 0);
            earLeft.rotation.y = Math.PI / 2;
            earRight.rotation.y = -Math.PI / 2;
            headScene.add(earLeft);
            headScene.add(earRight);

            const smileGeometry = new THREE.TorusGeometry(0.3, 0.04, 8, 16, Math.PI);
            const smileMaterial = new THREE.MeshBasicMaterial({ color: 0x00ffff, wireframe: true, side: THREE.DoubleSide });
            mouth = new THREE.Mesh(smileGeometry, smileMaterial);
            mouth.position.set(0, -0.6, 0.95);
            mouth.rotation.x = Math.PI / 2;
            headScene.add(mouth);

            const ambientLight = new THREE.AmbientLight(0x00ffff, 0.5);
            headScene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0x00ffff, 0.8);
            directionalLight.position.set(0, 1, 1).normalize();
            headScene.add(directionalLight);
        };

        // --- Three.js for Main Background ---
        let bgScene, bgCamera, bgRenderer;
        const PARTICLE_COUNT = 10000;
        const GRID_SIZE = 50;
        let bgParticles, bgGrid;

        const setupMainBackground = () => {
            bgScene = new THREE.Scene();
            bgCamera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            bgCamera.position.z = 20;
            
            // Add a grid
            const gridHelper = new THREE.GridHelper(GRID_SIZE, GRID_SIZE, 0x00ffff, 0x00ffff);
            gridHelper.rotation.x = Math.PI / 2;
            gridHelper.material.opacity = 0.2;
            gridHelper.material.transparent = true;
            bgGrid = gridHelper;
            bgScene.add(bgGrid);

            // Add particles
            const particleGeometry = new THREE.BufferGeometry();
            const positions = [];
            const colors = [];
            const color = new THREE.Color();
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                positions.push((Math.random() - 0.5) * GRID_SIZE * 2, (Math.random() - 0.5) * GRID_SIZE * 2, (Math.random() - 0.5) * GRID_SIZE * 2);
                color.setHSL(Math.random() * 0.1 + 0.5, 0.8, 0.5); // Blue-ish colors
                colors.push(color.r, color.g, color.b);
            }
            particleGeometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            particleGeometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            bgParticles = new THREE.Points(particleGeometry, new THREE.PointsMaterial({
                size: 0.1,
                vertexColors: true,
                transparent: true,
                opacity: 0.8
            }));
            bgScene.add(bgParticles);
        };

        // --- Animation Loop ---
        const animate = () => {
            requestAnimationFrame(animate);

            // Hologram head animation
            if (headRenderer && activeUi === 'main-ui') {
                if (eyeOpenDirection === 1) {
                    eyeOpenProgress += 0.05;
                    if (eyeOpenProgress > 1) { eyeOpenProgress = 1; eyeOpenDirection = 0; }
                } else if (eyeOpenDirection === -1) {
                    eyeOpenProgress -= 0.05;
                    if (eyeOpenProgress < 0) { eyeOpenProgress = 0; eyeOpenDirection = 0; }
                }
                eyeLeft.scale.y = eyeOpenProgress;
                eyeRight.scale.y = eyeOpenProgress;
                const eyeYOffset = 0.2 + (1 - eyeOpenProgress) * 0.1;
                eyeLeft.position.y = eyeYOffset;
                eyeRight.position.y = eyeYOffset;
                headRenderer.render(headScene, headCamera);
            }

            // Main background animation
            if (bgGrid) {
                bgGrid.rotation.z += 0.001;
            }
            if (bgParticles) {
                bgParticles.rotation.y += 0.0005;
                bgParticles.rotation.x += 0.0002;
            }
            if (bgRenderer) {
                bgRenderer.render(bgScene, bgCamera);
            }
        };

        // --- Window Resize Handling ---
        const onWindowResize = () => {
            if (headRenderer && activeUi === 'main-ui') {
                hologramCanvas.style.width = '100%';
                hologramCanvas.style.height = '400px';
                headCamera.aspect = hologramCanvas.offsetWidth / hologramCanvas.offsetHeight;
                headCamera.updateProjectionMatrix();
                headRenderer.setSize(hologramCanvas.offsetWidth, hologramCanvas.offsetHeight);
            }
            
            if (bgRenderer) {
                bgCamera.aspect = window.innerWidth / window.innerHeight;
                bgCamera.updateProjectionMatrix();
                bgRenderer.setSize(window.innerWidth, window.innerHeight);
            }
        };

        // --- Log and Speech Functions ---
        const addMessage = (text, sender) => {
            const now = new Date();
            const timestamp = now.toLocaleString();
            systemLog.push({ text, sender, timestamp });
            // Save log to local storage
            localStorage.setItem('systemLog', JSON.stringify(systemLog));

            const p = document.createElement('p');
            p.textContent = text;
            p.className = `${sender}-message`;
            if (activeUi === 'calculator') {
                calculatorMessageBox.appendChild(p);
                calculatorMessageBox.scrollTop = calculatorMessageBox.scrollHeight;
            } else {
                messageBox.appendChild(p);
                messageBox.scrollTop = messageBox.scrollHeight;
            }
        };

        const updateLogDisplay = () => {
            logDisplay.innerHTML = '';
            if (systemLog.length === 0) {
                 logDisplay.innerHTML = '<p class="text-gray-500 italic text-center mt-4">System activity will appear here.</p>';
                 return;
            }
            systemLog.forEach(log => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'log-entry';
                
                const timestampSpan = document.createElement('span');
                timestampSpan.className = 'log-timestamp';
                timestampSpan.textContent = `[${log.timestamp}]`;
                
                const messageSpan = document.createElement('span');
                messageSpan.className = `log-message log-${log.sender}`;
                messageSpan.textContent = log.text;
                
                entryDiv.appendChild(timestampSpan);
                entryDiv.appendChild(messageSpan);
                logDisplay.appendChild(entryDiv);
            });
            logDisplay.scrollTop = logDisplay.scrollHeight;
        };
        
        const speakResponse = (text) => {
            addMessage(text, 'jarvis');
            if (SpeechSynthesis && !isSpeaking) {
                isSpeaking = true;
                const utterance = new SpeechSynthesisUtterance(text);
                if (selectedVoice) { utterance.voice = selectedVoice; }
                utterance.onend = () => { isSpeaking = false; eyeOpenDirection = -1; };
                SpeechSynthesis.speak(utterance);
            }
        };

        const selectVoice = () => {
            const voices = SpeechSynthesis.getVoices();
            selectedVoice = voices.find(voice => voice.name.toLowerCase().includes('google') && !voice.name.toLowerCase().includes('female'));
            if (!selectedVoice) {
                selectedVoice = voices.find(voice => voice.lang.startsWith('en') && !voice.name.toLowerCase().includes('female') && !voice.name.toLowerCase().includes('child'));
            }
            if (!selectedVoice) {
                 selectedVoice = voices[0];
            }
            if (!selectedVoice) {
                 console.log("No suitable voice found.");
            }
        };
        if (SpeechSynthesis.onvoiceschanged !== undefined) {
            SpeechSynthesis.onvoiceschanged = selectVoice;
        }
        
        // --- Calculator Logic ---
        let currentInput = '';
        let operator = null;
        let firstOperand = null;
        let currentExpression = '';

        buttons.addEventListener('click', (event) => {
            const button = event.target;
            if (button.tagName !== 'BUTTON') return;
            const value = button.textContent;
            handleCalculatorInput(value);
        });
        
        const handleCalculatorInput = (value) => {
            if (value === 'C') {
                currentInput = '';
                operator = null;
                firstOperand = null;
                currentExpression = '';
                display.textContent = '0';
                addMessage('Calculation cleared.', 'jarvis');
            } else if (value === '=') {
                if (firstOperand !== null && operator && currentInput !== '') {
                    const secondOperand = parseFloat(currentInput);
                    let result;
                    try {
                        result = eval(`${firstOperand}${operator}${secondOperand}`);
                        display.textContent = result;
                        addMessage(`${currentExpression}${currentInput} = ${result}`, 'user');
                        currentInput = result.toString();
                        firstOperand = null;
                        operator = null;
                        currentExpression = '';
                    } catch (e) {
                        display.textContent = 'Error';
                        currentInput = '';
                        firstOperand = null;
                        operator = null;
                        currentExpression = '';
                        addMessage('Calculation error.', 'jarvis');
                    }
                }
            } else if (value === '+' || value === '-' || value === '*' || value === '/') {
                if (currentInput === '' && firstOperand === null) return;
                if (firstOperand !== null && operator && currentInput !== '') {
                    const secondOperand = parseFloat(currentInput);
                    const result = eval(`${firstOperand}${operator}${secondOperand}`);
                    firstOperand = result;
                    operator = value;
                    currentExpression = `${result}${value}`;
                    currentInput = '';
                    display.textContent = result;
                } else if (currentInput !== '') {
                    firstOperand = parseFloat(currentInput);
                    operator = value;
                    currentExpression = `${currentInput}${value}`;
                    currentInput = '';
                    addMessage(`${currentExpression}`, 'user');
                }
            } else {
                currentInput += value;
                display.textContent = currentInput;
            }
        };
        
        const wordToDigit = {
            'zero': '0', 'one': '1', 'two': '2', 'three': '3', 'four': '4', 'five': '5', 'six': '6', 'seven': '7', 'eight': '8', 'nine': '9',
            'plus': '+', 'minus': '-', 'times': '*', 'divided by': '/', 'equals': '='
        };

        const parseSpokenCommand = (text) => {
            const parts = text.split(' ');
            let command = '';
            for (const part of parts) {
                const normalizedPart = part.toLowerCase();
                const cleanPart = normalizedPart.replace(/[,.]/g, ''); // Remove punctuation
                
                if (wordToDigit[cleanPart]) {
                    command += wordToDigit[cleanPart];
                } else if (normalizedPart === 'divided' && parts.indexOf(part) + 1 < parts.length && parts[parts.indexOf(part) + 1] === 'by') {
                    command += '/';
                    i++; // Skip 'by'
                } else if (parseFloat(normalizedPart)) {
                    // Check if it's a number string
                    command += normalizedPart;
                }
            }
            return command;
        };

        // --- Clock Logic ---
        const updateClock = () => {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            timeDisplay.textContent = `${hours}:${minutes}:${seconds}`;
        };

        // --- Date Logic ---
        const updateDate = () => {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            currentDate.textContent = now.toLocaleDateString('en-US', options);
        };
        
        // --- Alarm Logic ---
        let alarmTime = null;

        const setAlarm = (timeString) => {
            if (!timeString) {
                speakResponse('Please specify a time for the alarm.');
                return;
            }
            
            const [hours, minutes] = timeString.split(':').map(Number);
            const now = new Date();
            alarmTime = new Date();
            alarmTime.setHours(hours, minutes, 0, 0);

            if (alarmTime <= now) {
                // If the time is in the past, set it for the next day
                alarmTime.setDate(alarmTime.getDate() + 1);
            }

            const timeToAlarm = alarmTime.getTime() - now.getTime();
            
            if (alarmTimeout) {
                clearTimeout(alarmTimeout);
            }
            
            alarmTimeout = setTimeout(() => {
                ringAlarm();
            }, timeToAlarm);
            
            setAlarmBtn.classList.add('hidden');
            cancelAlarmBtn.classList.remove('hidden');
            alarmStatus.textContent = `Alarm set for ${alarmTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`;
            speakResponse(`Alarm set for ${alarmTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })}.`);
        };
        
        const ringAlarm = () => {
            // Hide all UIs
            document.querySelectorAll('.full-ui').forEach(ui => ui.classList.remove('visible'));
            mainUi.style.opacity = '0';
            mainUi.style.display = 'none';

            // Show the special alarm ringing UI
            alarmRingingUi.classList.add('visible');
            ringingTime.textContent = alarmTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });

            alarmSound.play();
            speakResponse('Wake up, sir. It is time.');
            
            activeUi = 'alarm-ringing';
        };

        const stopAlarm = () => {
            if (alarmTimeout) {
                clearTimeout(alarmTimeout);
                alarmTimeout = null;
            }
            alarmSound.pause();
            alarmSound.currentTime = 0;
            alarmRingingUi.classList.remove('visible');
            setAlarmBtn.classList.remove('hidden');
            cancelAlarmBtn.classList.add('hidden');
            alarmStatus.textContent = ''; // Clear status message
            
            speakResponse('Alarm has been stopped.');
            
            // Return to main UI
            returnToMainUi();
        };

        const cancelAlarm = () => {
            if (alarmTimeout) {
                clearTimeout(alarmTimeout);
                alarmTimeout = null;
            }
            alarmSound.pause();
            alarmSound.currentTime = 0;
            alarmUi.classList.remove('ringing');
            setAlarmBtn.classList.remove('hidden');
            cancelAlarmBtn.classList.add('hidden');
            alarmStatus.textContent = 'Alarm is cancelled.';
            speakResponse('Alarm has been cancelled.');
        };
        
        // --- Screen Recording Logic ---
        const startScreenRecording = async () => {
            if (isRecording) {
                speakResponse('Screen recording is already in progress, sir.');
                return;
            }
            
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `J.A.R.V.I.S_Screen_Recording_${new Date().toISOString()}.webm`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    recordedChunks = [];
                    isRecording = false;
                    speakResponse('Screen recording saved successfully, sir. Please check your Downloads folder.');
                };
                
                mediaRecorder.start();
                isRecording = true;
                speakResponse('Screen recording started, sir.');
            } catch (err) {
                console.error('Error starting screen recording:', err);
                speakResponse('Sorry, I was unable to start the screen recording. Please grant the necessary permissions.');
            }
        };
        
        const stopScreenRecording = () => {
            if (isRecording && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                speakResponse('Screen recording stopped, sir. The file is being prepared for download.');
            } else {
                speakResponse('There is no active screen recording to stop.');
            }
        };
        
        // --- Virtual Keypad Logic ---
        let shiftActive = false;
        let capsActive = false;

        const keyboardLayout = [
            ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0', 'del'],
            ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p', 'send'],
            ['caps', 'a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l'],
            ['shift', 'z', 'x', 'c', 'v', 'b', 'n', 'm', ',', '.', '?'],
            [' '],
        ];

        const generateKeypad = () => {
            keypadButtons.innerHTML = '';
            keyboardLayout.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'flex w-full gap-2 justify-center';
                row.forEach(key => {
                    const btn = document.createElement('button');
                    btn.textContent = key;
                    btn.className = `key-btn ${key.length > 1 ? key : ''}`;
                    if (key === ' ') btn.className += ' space';
                    if (key === 'send') btn.className += ' send';
                    if (key === 'del') btn.className += ' del';
                    if (key === 'shift') btn.classList.toggle('bg-cyan-700', shiftActive);
                    if (key === 'caps') btn.classList.toggle('bg-cyan-700', capsActive);
                    
                    btn.addEventListener('click', () => handleKeypadInput(key));
                    keypadButtons.appendChild(btn);
                });
            });
        };
        
        const handleKeypadInput = (key) => {
            if (key === 'del') {
                keypadInput.value = keypadInput.value.slice(0, -1);
            } else if (key === 'send') {
                processCommandFromInput();
            } else if (key === 'shift') {
                shiftActive = !shiftActive;
                generateKeypad();
            } else if (key === 'caps') {
                capsActive = !capsActive;
                shiftActive = false;
                generateKeypad();
            } else if (key === ' ') {
                keypadInput.value += ' ';
                shiftActive = false;
                generateKeypad();
            } else {
                let charToAdd = key;
                if (shiftActive || capsActive) {
                    charToAdd = key.toUpperCase();
                }
                keypadInput.value += charToAdd;
                if (shiftActive) {
                    shiftActive = false;
                    generateKeypad();
                }
            }
            keypadInput.focus();
        };

        const processCommandFromInput = () => {
            const command = keypadInput.value.trim().toLowerCase();
            if (command) {
                addMessage(command, 'user');
                handleVoiceCommand(command);
                keypadInput.value = '';
            }
        };

        // --- Cinematic Transitions ---
        const openUiCinematic = (targetUi) => {
            mainUi.style.transition = 'all 1s cubic-bezier(0.77, 0, 0.175, 1)';
            mainUi.style.transform = 'scale(0) rotate(180deg)';
            mainUi.style.opacity = '0';
            
            // Clear any active intervals or timeouts
            if (clockInterval) clearInterval(clockInterval);
            
            setTimeout(() => {
                mainUi.style.display = 'none';
                document.querySelectorAll('.full-ui').forEach(ui => ui.classList.remove('visible')); // Ensure other UIs are hidden
                targetUi.classList.add('visible');
                activeUi = targetUi.id.replace('-ui', '');
            }, 1000);
        };

        const returnToMainUi = () => {
            // Hide the active UI
            document.querySelectorAll('.full-ui').forEach(ui => {
                if (ui.classList.contains('visible')) {
                    ui.classList.remove('visible');
                }
            });

            // Show main UI with a reverse transition
            mainUi.style.display = 'flex';
            mainUi.style.transition = 'all 1s ease-in-out';
            mainUi.style.transform = 'scale(1) rotate(0deg)';
            mainUi.style.opacity = '1';
            activeUi = 'main-ui';
            keypadInput.value = ''; // Clear keypad input on return
            shiftActive = false;
            capsActive = false;
        };

        // Command Pad UI Logic
        const commandList = [
            { name: "Jarvis", description: "J.A.R.V.I.S. কে জাগিয়ে তোলার জন্য ব্যবহার করুন।" },
            { name: "Open Calculator", description: "ক্যালকুলেটর খুলবে।" },
            { name: "Open Notepad", description: "নোটপ্যাড খুলবে।" },
            { name: "What's the Time", description: "বর্তমান সময় দেখাবে।" },
            { name: "What's the Date", description: "আজকের তারিখ দেখাবে।" },
            { name: "Where am I", description: "আপনার বর্তমান অবস্থান Google Maps-এ দেখাবে।" },
            { name: "Open YouTube", description: "YouTube খুলবে।" },
            { name: "Open Facebook", description: "Facebook খুলবে।" },
            { name: "Open Instagram", description: "Instagram খুলবে।" },
            { name: "Open WhatsApp", description: "WhatsApp খুলবে।" },
            { name: "Open Twitter", description: "Twitter খুলবে।" },
            { name: "Set an Alarm", description: "অ্যালার্ম সেট করার UI খুলবে।" },
            { name: "Start Screen Recording", description: "স্ক্রিন রেকর্ডিং শুরু করবে।" },
            { name: "Stop Screen Recording", description: "স্ক্রিন রেকর্ডিং বন্ধ করবে।" },
            { name: "Open Files", description: "ফাইল খোলার চেষ্টা করবে (বর্তমানে সীমিত)।" },
            { name: "Open 1234", description: "সিস্টেমের সমস্ত কার্যকলাপের লগ দেখাবে।" },
            { name: "Open Command Pad", description: "এই কমান্ড প্যাডটি খুলবে।" },
            { name: "Goodbye / Shut Down", description: "J.A.R.V.I.S. সিস্টেম বন্ধ করবে।" },
        ];

        const generateCommandPad = () => {
            commandPadContent.innerHTML = '';
            commandList.forEach(command => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'command-entry';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'command-name';
                nameSpan.textContent = command.name;
                
                const descriptionP = document.createElement('p');
                descriptionP.className = 'command-description';
                descriptionP.textContent = `- ${command.description}`;
                
                entryDiv.appendChild(nameSpan);
                entryDiv.appendChild(descriptionP);
                commandPadContent.appendChild(entryDiv);
            });
        };

        const showCommandPadCinematic = () => {
            // cinematic effect from eyes
            const hologramRect = hologramCanvas.getBoundingClientRect();
            const eyeCenter = {
                x: hologramRect.left + hologramRect.width / 2,
                y: hologramRect.top + hologramRect.height / 2
            };
            cinematicLight.style.left = `${eyeCenter.x}px`;
            cinematicLight.style.top = `${eyeCenter.y}px`;
            cinematicLight.style.opacity = '0.5';
            cinematicLight.style.transform = 'scale(0.01)';
            
            setTimeout(() => {
                cinematicLight.style.opacity = '0.1';
                cinematicLight.style.transform = 'scale(1)';
            }, 100);
            
            setTimeout(() => {
                cinematicLight.style.opacity = '0';
            }, 1000);

            // show command pad UI
            mainUi.style.transition = 'opacity 1s ease-in-out';
            mainUi.style.opacity = '0';
            
            setTimeout(() => {
                mainUi.style.display = 'none';
                document.querySelectorAll('.full-ui').forEach(ui => ui.classList.remove('visible'));
                commandPadUi.classList.add('visible');
                activeUi = 'command-pad';
                generateCommandPad();
            }, 1000);
        };

        // Central command handler for both voice and text input
        const handleVoiceCommand = (recognizedText) => {
             if (recognizedText.includes('jarvis')) {
                if (!hasSpokenStartupMessage) {
                    hasSpokenStartupMessage = true;
                    addMessage('System online.', 'jarvis');
                }
                eyeOpenDirection = 1;
                setTimeout(() => { speakResponse('Yes, sir.'); }, 500);
            } else if (recognizedText.includes('open calculator')) {
                openUiCinematic(calculator);
            } else if (recognizedText.includes('open notepad')) {
                openUiCinematic(notepad);
            } else if (recognizedText.includes('what the time') || recognizedText.includes('show me the time')) {
                openUiCinematic(clock);
                updateClock();
                clockInterval = setInterval(updateClock, 1000);
            } else if (recognizedText.includes('what the date') || recognizedText.includes("what's the date")) {
                openUiCinematic(dateDisplay);
                updateDate();
            } else if (recognizedText.includes('where i am') || recognizedText.includes('where am i')) {
                speakResponse("Showing your location on Google Maps, sir.");
                window.open("http://googleusercontent.com/maps.google.com/7", "_blank");
            } else if (recognizedText.includes('open youtube')) {
                mainUi.style.opacity = '0';
                mainUi.style.transition = 'opacity 1s ease-in-out';
                speakResponse('Opening YouTube, sir.');
                setTimeout(() => { window.open('https://www.youtube.com', '_blank'); }, 1000);
            } else if (recognizedText.includes('open facebook')) {
                mainUi.style.opacity = '0';
                mainUi.style.transition = 'opacity 1s ease-in-out';
                speakResponse('Opening Facebook, sir.');
                setTimeout(() => { window.open('https://www.facebook.com', '_blank'); }, 1000);
            } else if (recognizedText.includes('open instagram')) {
                mainUi.style.opacity = '0';
                mainUi.style.transition = 'opacity 1s ease-in-out';
                speakResponse('Opening Instagram, sir.');
                setTimeout(() => { window.open('https://www.instagram.com', '_blank'); }, 1000);
            } else if (recognizedText.includes('open whatsapp')) {
                mainUi.style.opacity = '0';
                mainUi.style.transition = 'opacity 1s ease-in-out';
                speakResponse('Opening WhatsApp, sir.');
                setTimeout(() => { window.open('https://web.whatsapp.com', '_blank'); }, 1000);
            } else if (recognizedText.includes('open twitter')) {
                mainUi.style.opacity = '0';
                mainUi.style.transition = 'opacity 1s ease-in-out';
                speakResponse('Opening Twitter, sir.');
                setTimeout(() => { window.open('https://x.com', '_blank'); }, 1000);
            } else if (recognizedText.includes('set an alarm')) {
                 openUiCinematic(alarmUi);
            } else if (recognizedText.includes('start screen recording')) {
                 startScreenRecording();
            } else if (recognizedText.includes('stop screen recording')) {
                 stopScreenRecording();
            } else if (recognizedText.includes('open files') || recognizedText.includes('show files')) {
                 speakResponse('I cannot directly open your local file system, sir. The recorded videos are in your browser\'s downloads folder.');
            } else if (recognizedText.includes('open 1234')) {
                openUiCinematic(logUi);
                updateLogDisplay();
                speakResponse('Accessing system logs.');
            } else if (recognizedText.includes('open command pad') || recognizedText.includes('show commands')) {
                 showCommandPadCinematic();
            } else if (recognizedText.includes('goodbye') || recognizedText.includes('shut down')) {
                statusDisplay.style.display = 'none';
                eyeOpenDirection = -1;
                shouldRestart = false;
                speakResponse('Goodbye, sir.');
                setTimeout(() => { recognition.stop(); }, 1000);
            } else {
                speakResponse('Command not recognized. Please try again or type a valid command.');
            }
        };

        const setupRecognition = () => {
            if (!SpeechRecognition) {
                statusDisplay.style.display = 'none';
                return;
            }
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'en-US'; // Set language to English
            recognition.onstart = () => { };
            recognition.onend = () => { if (shouldRestart) { setTimeout(() => { recognition.start(); }, 100); } };
            recognition.onerror = (event) => { if (event.error === 'not-allowed') { statusDisplay.style.display = 'none'; } };
            recognition.onresult = (event) => {
                const last = event.results.length - 1;
                const recognizedText = event.results[last][0].transcript.trim().toLowerCase();
                addMessage(recognizedText, 'user');
                handleVoiceCommand(recognizedText);
            };
            recognition.start();
        };

        window.onload = function () {
            selectVoice();
            setupMainBackground();
            setupHologram();
            
            // Set up the main renderer to be the background renderer
            bgRenderer = new THREE.WebGLRenderer({ canvas: backgroundCanvas, antialias: true, alpha: true });
            bgRenderer.setPixelRatio(window.devicePixelRatio);
            bgRenderer.setSize(window.innerWidth, window.innerHeight);

            window.addEventListener('resize', onWindowResize, false);
            onWindowResize();
            animate();
            setupRecognition();
            
            // Load saved log and notepad content from localStorage
            const savedLog = localStorage.getItem('systemLog');
            if (savedLog) {
                try {
                    systemLog = JSON.parse(savedLog);
                } catch (e) {
                    console.error("Failed to parse saved log data:", e);
                    systemLog = []; // Reset if data is corrupt
                }
            }
            
            const savedNotepadContent = localStorage.getItem('notepadContent');
            if (savedNotepadContent) {
                notepadText.value = savedNotepadContent;
            }

            // Save content to localStorage whenever it changes
            notepadText.addEventListener('input', () => {
                localStorage.setItem('notepadContent', notepadText.value);
            });

            // Add event listeners for the new Back buttons
            calcBackBtn.addEventListener('click', returnToMainUi);
            notepadBackBtn.addEventListener('click', returnToMainUi);
            clockBackBtn.addEventListener('click', returnToMainUi);
            dateBackBtn.addEventListener('click', returnToMainUi);
            alarmBackBtn.addEventListener('click', returnToMainUi);
            stopAlarmBtn.addEventListener('click', stopAlarm);
            logBackBtn.addEventListener('click', returnToMainUi);
            commandPadBackBtn.addEventListener('click', returnToMainUi);
            
            // New: Keypad UI event listeners
            messageBox.addEventListener('click', () => {
                openUiCinematic(keypadUi);
                generateKeypad(); // Re-generate to ensure correct capitalization state
                keypadInput.focus();
            });
            keypadBackBtn.addEventListener('click', returnToMainUi);
            keypadInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Prevents newline in input
                    processCommandFromInput();
                }
            });

            // Add event listeners for the alarm UI
            setAlarmBtn.addEventListener('click', () => {
                setAlarm(alarmTimeInput.value);
            });
            cancelAlarmBtn.addEventListener('click', cancelAlarm);
            
            // New: Delete Logs button listener
            deleteLogsBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to delete all logs? This cannot be undone.')) {
                    localStorage.removeItem('systemLog');
                    systemLog = [];
                    updateLogDisplay();
                    speakResponse('All system logs have been deleted.');
                }
            });
        };
    </script>
</body>
</html>
<script type="text/javascript">
	atOptions = {
		'key' : 'e0935ce5dcaa78a0cbebfc99dbf7f539',
		'format' : 'iframe',
		'height' : 50,
		'width' : 320,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/e0935ce5dcaa78a0cbebfc99dbf7f539/invoke.js"></script>